---
// src/pages/demos/shop/[store]/index.astro
import Layout from '../../../../layouts/Layout.astro';
import Footer from '../../../../components/Footer.astro';
import { STORE_DATA } from '../../../../data/store-data';

export function getStaticPaths() {
  return Object.keys(STORE_DATA).map(slug => ({
    params: { store: slug },
    props: { storeData: STORE_DATA[slug] },
  }));
}

const { storeData } = Astro.props;
const { store } = Astro.params;
const allCategories = ['All', ...new Set(storeData.products.map(p => p.category))];

// Filter for "Trending" items (tagged with 'Best Seller', 'New', 'Viral', 'Flagship')
const trendingProducts = storeData.products.filter(p => 
    p.tags.some(t => ['Best Seller', 'New', 'Viral', 'Flagship'].includes(t))
).slice(0, 3);
---

<Layout title={`${storeData.name} | Shop Demo`}>
  <script is:inline>
    // Shopping Cart Logic
    window.cart = []; 
    function toggleCart() {
      const drawer = document.getElementById('cart-drawer');
      const backdrop = document.getElementById('cart-backdrop');
      drawer.classList.toggle('translate-x-full');
      backdrop.classList.toggle('opacity-0');
      backdrop.classList.toggle('pointer-events-none');
    }
    function addToCart(title, price) {
        window.cart.push({ title, price });
        document.getElementById('cart-count').innerText = window.cart.length;
        const items = document.getElementById('cart-items');
        items.innerHTML = window.cart.map(item => `
            <div class="flex justify-between py-2 border-b border-gray-100">
                <span class="text-sm font-medium">${item.title}</span>
                <span class="text-sm">RM ${item.price}</span>
            </div>
        `).join('');
        const total = window.cart.reduce((sum, item) => sum + item.price, 0);
        document.getElementById('cart-subtotal').innerText = 'RM ' + total;
        toggleCart();
    }
    function filterCategory(cat) {
        document.querySelectorAll('.product-card').forEach(p => {
            p.style.display = (cat === 'All' || p.dataset.category === cat) ? 'block' : 'none';
        });
        document.querySelectorAll('.cat-link').forEach(l => l.classList.remove('font-bold', 'text-black'));
        document.getElementById(`link-${cat}`).classList.add('font-bold', 'text-black');
    }
  </script>

  <nav class="sticky top-0 z-40 bg-white/90 backdrop-blur-md border-b border-gray-100">
    <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
      <a href={`/demos/shop/${store}`} class="text-xl font-serif font-bold tracking-widest text-gray-900 uppercase">
        {storeData.name}
      </a>
      <div class="flex items-center gap-6">
          <a href="/storefronts" class="text-xs font-bold text-gray-400 hover:text-black uppercase tracking-wide hidden md:block">
            &larr; Exit Demo
          </a>
          <button onclick="toggleCart()" class="flex items-center gap-2 font-medium text-sm hover:text-gray-600">
            Cart (<span id="cart-count">0</span>)
          </button>
      </div>
    </div>
  </nav>

  <div class="relative h-[60vh] overflow-hidden">
    <img src={storeData.heroImage} class="w-full h-full object-cover" />
    <div class="absolute inset-0 bg-black/30 flex items-center justify-center text-center">
        <div class="text-white max-w-lg px-4 animate-fade-in-up">
            <h1 class="text-4xl md:text-6xl font-serif font-bold mb-4">{storeData.name}</h1>
            <p class="text-white/90 text-lg mb-8">{storeData.description}</p>
            <button onclick="document.getElementById('shop-grid').scrollIntoView({behavior: 'smooth'})" class="bg-white text-black px-8 py-3 font-bold uppercase tracking-widest hover:bg-black hover:text-white transition">
                Shop Now
            </button>
        </div>
    </div>
  </div>

  <div class="bg-gray-50 py-8 border-b border-gray-100">
      <div class="max-w-7xl mx-auto px-6 grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
          <div class="flex flex-col items-center gap-2">
              <svg class="w-6 h-6 text-gray-900" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
              <h3 class="font-bold text-xs uppercase tracking-widest">Free Shipping Over RM150</h3>
          </div>
          <div class="flex flex-col items-center gap-2">
              <svg class="w-6 h-6 text-gray-900" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
              <h3 class="font-bold text-xs uppercase tracking-widest">Secure Payment</h3>
          </div>
          <div class="flex flex-col items-center gap-2">
              <svg class="w-6 h-6 text-gray-900" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
              <h3 class="font-bold text-xs uppercase tracking-widest">30-Day Returns</h3>
          </div>
      </div>
  </div>

  <div class="flex min-h-screen bg-white" id="shop-grid">
    <aside class="hidden lg:block w-64 p-8 border-r border-gray-100">
      <h3 class="font-bold text-xs uppercase tracking-widest mb-6 text-gray-900">Collections</h3>
      <ul class="space-y-3 text-sm text-gray-600 sticky top-24">
        {allCategories.map(cat => (
          <li>
            <button id={`link-${cat}`} onclick={`filterCategory('${cat}')`} class={`cat-link text-left w-full hover:text-black hover:underline underline-offset-4 ${cat === 'All' ? 'font-bold text-black' : ''}`}>
                {cat}
            </button>
          </li>
        ))}
      </ul>
    </aside>

    <main class="flex-1 p-6 lg:p-12">
        {trendingProducts.length > 0 && (
            <div class="mb-16">
                <h2 class="text-2xl font-serif font-bold mb-6">Trending Now</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {trendingProducts.map(product => (
                        <a href={`/demos/shop/${store}/${product.slug}`} class="group">
                            <div class="aspect-square bg-gray-100 mb-3 overflow-hidden rounded-sm relative">
                                <img src={product.image} class="w-full h-full object-cover group-hover:scale-105 transition duration-500" />
                                <span class="absolute top-2 left-2 bg-black text-white px-2 py-1 text-[10px] font-bold uppercase tracking-wide">
                                    Trending
                                </span>
                            </div>
                            <h3 class="font-bold text-sm">{product.name}</h3>
                            <p class="text-gray-500 text-sm">RM {product.price}</p>
                        </a>
                    ))}
                </div>
            </div>
        )}

        <div class="flex justify-between items-end mb-6">
            <h2 class="text-xl font-bold uppercase tracking-widest text-gray-900">All Products</h2>
            
            <div class="lg:hidden overflow-x-auto flex gap-2 max-w-[50%]">
                {allCategories.map(cat => (
                    <button onclick={`filterCategory('${cat}')`} class="flex-shrink-0 px-3 py-1 bg-gray-100 rounded-full text-[10px] font-bold whitespace-nowrap">
                        {cat}
                    </button>
                ))}
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-12">
            {storeData.products.map((product) => (
                <div class="product-card group block cursor-pointer" data-category={product.category}>
                    <div class="relative aspect-[3/4] bg-gray-100 mb-4 overflow-hidden rounded-sm">
                        <a href={`/demos/shop/${store}/${product.slug}`}>
                            <img src={product.image} class="w-full h-full object-cover group-hover:scale-105 transition duration-500" />
                        </a>
                        
                        {product.tags.includes('New') && (
                            <span class="absolute top-2 right-2 bg-white px-2 py-1 text-[10px] font-bold uppercase tracking-wide border border-gray-100">New</span>
                        )}

                        <button onclick={`addToCart('${product.name}', ${product.price})`} class="absolute bottom-0 w-full bg-white/90 backdrop-blur py-3 text-center translate-y-full group-hover:translate-y-0 transition duration-300 font-bold uppercase text-xs tracking-widest hover:bg-black hover:text-white">
                            Add to Cart
                        </button>
                    </div>
                    <a href={`/demos/shop/${store}/${product.slug}`}>
                        <h3 class="text-lg font-serif text-gray-900 leading-tight group-hover:underline decoration-1 underline-offset-4">{product.name}</h3>
                        <p class="text-gray-500 text-sm mt-1">RM {product.price}</p>
                    </a>
                </div>
            ))}
        </div>
    </main>
  </div>

  <section class="bg-black text-white py-20 px-6 text-center">
      <div class="max-w-2xl mx-auto">
          <h2 class="text-3xl font-serif font-bold mb-4">Join the {storeData.name} Club.</h2>
          <p class="text-gray-400 mb-8">Get 10% off your first order and early access to new drops. No spam, just the good stuff.</p>
          <div class="flex gap-2 max-w-sm mx-auto">
              <input type="email" placeholder="Enter your email" class="flex-1 bg-white/10 border border-white/20 px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-white" />
              <button class="bg-white text-black font-bold uppercase px-6 py-3 hover:bg-gray-200">Sign Up</button>
          </div>
      </div>
  </section>

  <div id="cart-backdrop" onclick="toggleCart()" class="fixed inset-0 bg-black/40 z-50 opacity-0 pointer-events-none transition-opacity duration-300"></div>
  <div id="cart-drawer" class="fixed top-0 right-0 h-full w-full max-w-sm bg-white z-50 transform translate-x-full transition-transform duration-300 shadow-2xl flex flex-col">
    <div class="p-6 border-b border-gray-100 flex justify-between items-center">
        <h2 class="font-serif font-bold">Your Bag</h2>
        <button onclick="toggleCart()" class="text-2xl">&times;</button>
    </div>
    <div id="cart-items" class="flex-1 p-6 overflow-y-auto"></div>
    <div class="p-6 bg-gray-50 border-t border-gray-100">
        <div class="flex justify-between font-bold mb-4"><span>Subtotal</span><span id="cart-subtotal">RM 0</span></div>
        <button class="w-full bg-black text-white py-3 font-bold uppercase hover:bg-gray-800">Checkout</button>
    </div>
  </div>
  <Footer />
</Layout>